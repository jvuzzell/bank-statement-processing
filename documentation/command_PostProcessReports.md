# PostProcessReports Command

The PostProcessReports command adjusts the transaction and trend reports generated by the RunStatementsReports command. This script replaces terms in the reports based on a provided translation map and formats transaction amounts. This document provides an overview of the purpose, configuration, and usage of the PostProcessReports command.

## Purpose

The PostProcessReports command exists to process and clean up the CSV reports generated from bank statements. It applies term replacements and formats transaction amounts to ensure consistency and readability.

## Prerequisites

Ensure you have the following:

- PHP 7.4 or higher
- Composer dependencies installed
- Directory structure with necessary input and output files

## Directory Structure

- **input/statements/**: Directory containing bank statement files to be processed.
- **tmp/**: Directory where the generated reports will be saved.
- **search_terms/**: Directory containing search term translations used for replacements.

## Configuration

Ensure your config.php file defines the following constants:

- SEARCH_TERMS_DIR: Path to the directory containing search term translations.
- TMP_DIR: Path to the temporary directory where reports will be saved.

## Usage

To run the PostProcessReports command, execute the following from the command line:

```bash
php console.php PostProcessReports
```

## Process Overview

The command performs the following steps:

1. **Load Replacement Map:**
    - Reads the translation map from a CSV file in the SEARCH_TERMS_DIR.
1. **Replace Terms and Format Amounts:**
    - Processes the transactions_report.csv and recurring-expenses_report.csv files.
    - Replaces terms based on the translation map.
    - Formats transaction amounts by removing commas.
    - Saves the updated reports to the TMP_DIR/reports/ directory.

**Detailed Breakdown**

**1\. Load Replacement Map**

- **Function: loadReplacementMap($filename)**

    Reads the translation map CSV file and loads it into an associative array.

    ```php
    function loadReplacementMap($filename) {
        $map = \[\];

        if (($handle = fopen($filename, "r")) !== FALSE) {

            while (($data = fgetcsv($handle, 1000, ",")) !== FALSE) {
                $map\[$data\[0\]\] = $data\[1\];
            }

            fclose($handle);

        }

        return $map;
    }
    ```

**2\. Replace Terms and Format Amounts**

- **Function: replaceTermsInCsv($sourceCsv, $replacementMapCsv, $outputCsv)**

    Processes the input CSV file to replace terms and format transaction amounts, then saves the result to the output CSV file.

    ```php
    function replaceTermsInCsv($sourceCsv, $replacementMapCsv, $outputCsv) {

        $replacementMap = loadReplacementMap($replacementMapCsv);

        $transactionAmountColumnIndex = null;

        if (($inputHandle = fopen($sourceCsv, "r")) !== FALSE) {

            $outputHandle = fopen($outputCsv, "w");

            // Read the header row and write it to the output as is, while identifying the transaction_amount column index

            if (($header = fgetcsv($inputHandle)) !== FALSE) {

                foreach ($header as $index => $columnName) {
                    if ($columnName == 'Transaction Amount') {
                        $transactionAmountColumnIndex = $index;
                    }
                }

                fputcsv($outputHandle, $header);

            }

            while (($data = fgetcsv($inputHandle)) !== FALSE) {

                foreach ($data as $key => $value) {

                    if ($key === $transactionAmountColumnIndex) {
                        $data\[$key\] = str_replace(',', '', $value);
                    }

                    foreach ($replacementMap as $searchTerm => $replaceTerm) {

                        if (strpos($value, $searchTerm) !== false) {
                            $data\[$key\] = str_replace($searchTerm, $replaceTerm, $value);
                            break;
                        }

                    }

                }

                fputcsv($outputHandle, $data);

            }

            fclose($inputHandle);
            fclose($outputHandle);

        }

    }
    ```

## Usage

```php
$searchTermTranslations = SEARCH_TERMS_DIR . 'translations.csv';

$recurringTrendsReportFilename = TMP_DIR . "recurring-expenses_report.csv";

$transactionReportFilename = TMP_DIR . "transactions_report.csv";

$outputFilename = TMP_DIR . "reports/transactions_report.csv";

replaceTermsInCsv($transactionReportFilename, $searchTermTranslations, $outputFilename);

$outputFilename = TMP_DIR . "reports/recurring-expenses_report.csv";

replaceTermsInCsv($recurringTrendsReportFilename, $searchTermTranslations, $outputFilename);
```

## Output Files

- **tmp/reports/transactions_report.csv**: Processed and cleaned transaction report.
- **tmp/reports/recurring-expenses_report.csv**: Processed and cleaned recurring expenses report.

## Conclusion

The PostProcessReports command is essential for cleaning and formatting the reports generated by the RunStatementsReports command. By following the steps outlined in this guide, you can successfully run the command and utilize the cleaned reports for further analysis.